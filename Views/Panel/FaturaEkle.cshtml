@*@model List<Muhasebe.Models.model_fatura_altUrun_liste>*@
@model Muhasebe.Models.Fatura


@{
    ViewBag.Title = "FaturaEkle";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}
<form id="faturaEkleKaydetForm" method="post">
    @Html.HiddenFor(model => model.Id, new { @value = "0" })
    <div class="p-box">
        <div class="row">
            <div class="col-md-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Fatura Ekle</h3>
                    </div>
                    <div class="box-body">

                        <div class="form-horizontal">
                            <h4>Fatura</h4>
                            <hr />
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                            <div class="form-group">
                                @Html.LabelFor(model => model.Aciklama, htmlAttributes: new { @class = "control-label col-md-2" })
                                <div class="col-md-10">
                                    @Html.EditorFor(model => model.Aciklama, new { htmlAttributes = new { @class = "form-control", @id = "Aciklama" } })
                                    @Html.ValidationMessageFor(model => model.Aciklama, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-2">
                                    <h5 style="float:right; font-weight:700">Kategoriler</h5>
                                </div>
                                <div class="col-md-10">
                                    @if (ViewBag.katttt == null)
                                    {
                                        <input type="text" name="kategoriler" id="kategoriler" value="" data-role="tagsinput" />
                                    }
                                    else
                                    {
                                        <input type="text" name="kategoriler" value="@ViewBag.katttt" id="kategoriler" data-role="tagsinput" />
                                    }

                                </div>
                            </div>

                            <div class="form-group">
                                <p class="control-label col-md-2">Müşteri</p>
                                <div class="col-md-10">
                                    @Html.DropDownListFor(model => model.MusteriID, new SelectList(ViewBag.musteri, "Id", "FirmaUnvani"), ""@*, new { htmlAttributes = new { @id = "MusteriID" } }*@)
                                    @Html.ValidationMessageFor(model => model.MusteriID, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            @if (Model == null)
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.Irsaliye, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.Irsaliye, new SelectList(ViewBag.irsaliye, "Ad", "Ad"), new { htmlAttributes = new { @id = "Irsaliye" } })
                                        @Html.ValidationMessageFor(model => model.Irsaliye, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.Irsaliye, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.Irsaliye, new SelectList(ViewBag.irsaliye, "Ad", "Ad"), Model.Irsaliye, new { htmlAttributes = new { @id = "Irsaliye" } })
                                        @Html.ValidationMessageFor(model => model.Irsaliye, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }

                            <div class="form-group">
                                @Html.LabelFor(model => model.DuzenlemeTarih, htmlAttributes: new { @class = "control-label col-md-2" })
                                <div class="col-md-10">
                                    @Html.EditorFor(model => model.DuzenlemeTarih, new { htmlAttributes = new { @class = "form-control datepicker", @id = "DuzenlemeTarih" } })
                                    @Html.ValidationMessageFor(model => model.DuzenlemeTarih, "", new { @class = "text-danger" })
                                </div>
                            </div>

                            <div class="form-group">
                                @Html.LabelFor(model => model.VadeTarihi, htmlAttributes: new { @class = "control-label col-md-2" })
                                <div class="col-md-10">
                                    @Html.EditorFor(model => model.VadeTarihi, new { htmlAttributes = new { @class = "form-control datepicker", @id = "VadeTarihi" } })
                                    @Html.ValidationMessageFor(model => model.VadeTarihi, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div>
                                <p class="control-label col-md-2">Fatura No:</p>
                                <div class="form-group col-md-5">
                                    <p class="control-label col-md-2">Seri</p>
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.FaturaNoSeri, new { htmlAttributes = new { @class = "", @id = "FaturaNoSeri" } })
                                        @Html.ValidationMessageFor(model => model.FaturaNoSeri, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="form-group col-md-5">
                                    <p class="control-label col-md-2">Sıra</p>
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.FaturaNoSira, new { htmlAttributes = new { @class = "", @id = "FaturaNoSira" } })
                                        @Html.ValidationMessageFor(model => model.FaturaNoSira, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            @if (Model == null)
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.FaturaDovizi, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.FaturaDovizi, new SelectList(ViewBag.faturaDoviz, "Ad", "Ad"), new { htmlAttributes = new { @class = "" } })
                                        @Html.ValidationMessageFor(model => model.FaturaDovizi, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.FaturaDovizi, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.FaturaDovizi, new SelectList(ViewBag.faturaDoviz, "Ad", "Ad"), Model.FaturaDovizi, new { htmlAttributes = new { @class = "" } })
                                        @Html.ValidationMessageFor(model => model.FaturaDovizi, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }

                            <div class="form-group">
                                <div class="col-md-offset-2 col-md-10">
                                    <a class="btn col-md-12 btn-primary" onclick="return islemler.UrunKaydet()">
                                        <i class="fa fa-save"></i> Kaydet
                                    </a>
                                </div>
                            </div>
                        </div>
                        @*Tablo kısmı*@

                        @Html.DropDownList("urunAd", new SelectList(ViewBag.urun, "Id", "Ad"), new { @class = "hidden form-control" })

                        @Html.DropDownList("urunKdv", new SelectList(ViewBag.kdv, "Miktar", "Miktar"), new { @class = "hidden form-control" })
                        @Html.DropDownList("fiyat", new SelectList(ViewBag.urun, "Id", "VergilerHaricSatis"), new { @class = "hidden from-control VergilerHaricSatis " })
                        <hr />
                        <table id="urunler" class="table table-striped table-bordered align-items-baseline col-md-12">
                            <thead style="background-color:lightgray;">
                                <tr style="height:40px;">
                                    <th>
                                        Hizmet/Ürün
                                    </th>
                                    <th>
                                        Miktar
                                    </th>
                                    <th>
                                        BR. FİYAT
                                    </th>
                                    <th>
                                        VERGİ
                                    </th>
                                    <th>
                                        TOPLAM
                                    </th>
                                    <th>

                                    </th>
                                </tr>
                            </thead>
                            <tbody>

                                @if (ViewBag.list != null)
                                {
                                    foreach (var itemi in ViewBag.list)
                                    {

                                        <tr>
                                            <td>
                                                <input type="hidden" class="altId" value="@itemi.altId" />
                                                @Html.DropDownList("urunAd", new SelectList(ViewBag.urun, "Id", "Ad", itemi.HizmetUrunID), new { @class = " form-control select2 HizmetUrunID" })
                                            </td>
                                            <td>
                                                <input style="margin:15px; width:90%;" class="form-control Miktar" type="number" name="Miktar" value="@itemi.Miktar" />
                                            </td>
                                            <td>

                                                @Html.DropDownList("fiyat", new SelectList(ViewBag.urun, "Id", "VergilerHaricSatis", itemi.HizmetUrunID), new { @class = "hidden from-control VergilerHaricSatis " })

                                                @*<input type="hidden" class="Fiyatt" value="@itemi.VergilerHaricSatis" />*@
                                                <input style="margin:15px; width:90%;" class="form-control BirimFiyat" type="number" name="BirimFiyat" value="@itemi.BirimFiyat" />
                                            </td>
                                            <td>
                                                @Html.DropDownList("urunKdv", new SelectList(ViewBag.kdv, "Miktar", "Miktar", itemi.Vergi), new { @class = "form-control Vergi" })

                                            </td>
                                            <td>
                                                <input style="margin:15px; width:90%;" class="form-control Toplam" name="Toplam" value="@itemi.Toplam" type="number">

                                            </td>
                                            <td>
                                                <button type="button" id="urunSil" class="btn col-md-2 btn-primary">x</button>
                                            </td>
                                        </tr>



                                    }

                                }
                            </tbody>
                        </table>


                        <button type="button" id="urunEkle" class="btn col-md-2 btn-primary">Satır Ekle</button>
                        @*<a class="add btn col-md-2 btn-primary">
            Satır Ekle
        </a>*@
                        <hr />
                        <div class="col-md-6" style="float:right">

                            @{

                                if (Model != null)
                                {
                                    <p style="display:inline-block">Ara Toplam:</p>
                                    <input type="text" class="AraToplam" value="@Model.AraToplam" disabled />
                                    <hr />
                                    <p style="display:inline-block">Toplam KDV:</p>
                                    <input type="text" class="KdvToplam" value="@Model.KdvToplam" disabled />
                                    <hr />
                                    <p style="display:inline-block">Genel Toplam:</p>
                                    <input type="text" class="GenelToplam" value="@Model.GenelToplam" disabled />
                                    <hr />
                                }
                                else
                                {
                                    <p style="display:inline-block">Ara Toplam:</p>
                                    <input type="text" class="AraToplam" value="0" disabled />
                                    <hr />
                                    <p style="display:inline-block">Toplam KDV:</p>
                                    <input type="text" class="KdvToplam" value="0" disabled />
                                    <hr />
                                    <p style="display:inline-block">Genel Toplam:</p>
                                    <input type="text" class="GenelToplam" value="0" disabled />
                                    <hr />
                                }


                            }
                        </div>

                        <div>
                            @Html.ActionLink("Listeye Dön", "Faturalar")
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>



    $(function () {
        $('.select2').select2();
        //get elements by class name ile ürünleri alıp select 2 eklettir.
        $(".datepicker").datepicker({
            autoclose: true,
        });
        urunlerTablo = $("#urunler").DataTable({
            "paging": false,
            "ordering": false,
            "info": false,
            "searching": false,
            "columnDefs": [
                { "width": "10%", "targets": 0 }
            ]
        });


        $(document).ready(function () {
            
            var dat = $("#urunKdv").html();
            var dat2 = $("#urunAd").html();
            var dat3 = $("#fiyat").html();
            
            $('#urunler tbody').on('click', '#urunSil', function () {
                urunlerTablo
                    .row($(this).parents('tr'))
                    .remove()
                    .draw();

                toplamHesaplamaa()
            }); 

            $("#urunEkle").on('click', function () {
                urunlerTablo.row.add([
                    '<select style="margin:15px; width:90%;" class="form-control select2 HizmetUrunID" name="HizmetUrunID" >' + dat2 + '<select/>', '<input style="margin:15px;width:90%;"class="formcontrol Miktar" type="number" name="Miktar"  value="" />', '<input style="margin:15px; width:90%;" class="form-control BirimFiyat"type="number"name="BirimFiyat" value="" /><select style="margin:15px; width:90%;" class="form-control hidden VergilerHaricSatis" name="VergilerHaricSatis" >' + dat3 + '<select />', '<select  class="form-control Vergi" name="Vergi" >' + dat + '<select/>', '<input style="margin:15px; width:90%;" class="formcontrol Toplam"type="number">', '<button type = "button" id = "urunSil" class= "btn col-md-2 btn-primary" > x</button >']).draw(false);

                $('.select2').select2();

                //yeni fatura ürün fiyatını getirme
                $("tr").each(function (index, value) {
                    var VHS = $(this).find(".VergilerHaricSatis");
                    var hui = $(this).find(".HizmetUrunID");
                    var bFiyat = $(this).find(".BirimFiyat");
                    var ab = $(this).find('.VergilerHaricSatis');

                    if (index != 0) {
                        $(this).find(".HizmetUrunID").change(function () {
                            var satis = VHS;
                            var hid = hui.val();

                            satis.val(hid);

                            var seciliYazi = ab.find('option:selected').text();
                            bFiyat.val(seciliYazi)
                            toplamHesaplamaa()
                        })
                    }
                })

                //Yeni fatura/ürün Hesaplamalar
                $(".BirimFiyat").on("input", function () {
                    toplamHesaplamaa()
                })
                $(".Miktar").on("input", function () {
                    toplamHesaplamaa()
                })
                $(".Vergi").change(function () {
                    toplamHesaplamaa()
                })
                $(".Toplam").on("input", function () {
                    birimFiyatHesaplama()
                })
                function birimFiyatHesaplama() {
                    var araToplam = 0;
                    var genelToplam = 0;
                    var kdvToplam = 0;
                    $("tr").each(function (index, value) {
                        if (index != 0) {
                            //birim fiyat bulma
                            var miktar = $(this).find(".Miktar").val();
                            var birimFiyat = $(this).find(".BirimFiyat");
                            var vergi = $(this).find(".Vergi").val();
                            var toplam = parseFloat($(this).find(".Toplam").val());
                            var vFiyat = ((toplam / (1 + (vergi / 100))) / miktar).toFixed(2);
                            birimFiyat.val(vFiyat);

                            //ara toplam
                            var araFiyat = miktar * vFiyat;
                            araToplam = araToplam + araFiyat;
                            $(".AraToplam").val(araToplam.toFixed(2))
                            //genel Toplam
                            genelToplam += toplam;
                            $(".GenelToplam").val(genelToplam.toFixed(2))
                            //kdv toplam
                            kdvToplam = genelToplam - araToplam;
                            $(".KdvToplam").val(kdvToplam.toFixed(2));
                        }

                    })
                }
                function toplamHesaplamaa() {
                    var araToplam = 0;
                    var genelToplam = 0;
                    var kdvToplam = 0;
                    $("tr").each(function (index, value) {
                        if (index != 0) {
                            //ürünlerin kendi toplam fiyatlarını bulma
                            var miktar = parseFloat($(this).find(".Miktar").val());
                            var birimFiyat = parseFloat($(this).find(".BirimFiyat").val());
                            var vergi = parseFloat($(this).find(".Vergi").val());
                            var toplam = $(this).find(".Toplam");
                            var toplamm = parseFloat((miktar * (birimFiyat * (1 + (vergi / 100)))).toFixed(2));
                            toplam.val(toplamm);

                            //ara toplam bulma
                            var araFiyat = miktar * birimFiyat;
                            araToplam = araToplam + araFiyat;
                            $(".AraToplam").val(araToplam.toFixed(2))
                            //genel toplam bulma
                            genelToplam += toplamm;
                            $(".GenelToplam").val(genelToplam.toFixed(2))
                            //kdv toplam bulma
                            kdvToplam = genelToplam - araToplam;
                            $(".KdvToplam").val(kdvToplam.toFixed(2))
                        }

                    })
                }
            })
            
        })
    })

    //Ürünün fiyatını getirme (Düzeldi)
    

    $("tr").each(function (index, value) {
            var VHS = $(this).find(".VergilerHaricSatis");
            var hui = $(this).find(".HizmetUrunID");
            var bFiyat = $(this).find(".BirimFiyat");
            var ab = $(this).find('.VergilerHaricSatis');
           
            if (index != 0) {
                $(this).find(".HizmetUrunID").change(function () {
                    var satis = VHS;
                    var hid = hui.val();
                    
                    satis.val(hid);

                    var seciliYazi = ab.find('option:selected').text();
                    bFiyat.val(seciliYazi)
                    toplamHesaplamaa()
                })
            }
    })

    //Düzenleme Hesaplamalar
    $(".BirimFiyat").on("input", function (){
        toplamHesaplamaa()
    })
    $(".Miktar").on("input", function () {
        toplamHesaplamaa()
    })
    $(".Vergi").change(function () {
        toplamHesaplamaa()
    })
    $(".Toplam").on("input", function () {
        birimFiyatHesaplama()
    })
    function birimFiyatHesaplama() {
        var araToplam = 0;
        var genelToplam = 0;
        var kdvToplam = 0;
        $("tr").each(function (index, value) {
            if (index != 0) {
                //birim fiyat bulma
                var miktar = $(this).find(".Miktar").val();
                var birimFiyat = $(this).find(".BirimFiyat");
                var vergi = $(this).find(".Vergi").val();
                var toplam = parseFloat($(this).find(".Toplam").val());
                var vFiyat = ((toplam / (1 + (vergi / 100))) / miktar).toFixed(2);
                birimFiyat.val(vFiyat);

                //ara toplam
                var araFiyat = miktar * vFiyat;
                araToplam = araToplam + araFiyat;
                $(".AraToplam").val(araToplam.toFixed(2))
                //genel Toplam
                genelToplam += toplam;
                $(".GenelToplam").val(genelToplam.toFixed(2))
                //kdv toplam
                kdvToplam = genelToplam - araToplam;
                $(".KdvToplam").val(kdvToplam.toFixed(2));
            }

        })
    }
    function toplamHesaplamaa() {
        var araToplam = 0;
        var genelToplam = 0;
        var kdvToplam = 0;
        $("tr").each(function (index, value) {
            if (index != 0) {
                //ürünlerin kendi toplam fiyatlarını bulma
                var miktar = parseFloat($(this).find(".Miktar").val());
                var birimFiyat = parseFloat($(this).find(".BirimFiyat").val());
                var vergi = parseFloat($(this).find(".Vergi").val());
                var toplam = $(this).find(".Toplam");
                var toplamm = parseFloat((miktar * (birimFiyat * (1 + (vergi / 100)))).toFixed(2));
                toplam.val(toplamm);

                //ara toplam bulma
                var araFiyat = miktar * birimFiyat;
                araToplam = araToplam + araFiyat;
                $(".AraToplam").val(araToplam.toFixed(2))
                //genel toplam bulma
                genelToplam += toplamm;
                $(".GenelToplam").val(genelToplam.toFixed(2))
                //kdv toplam bulma
                kdvToplam = genelToplam - araToplam;
                $(".KdvToplam").val(kdvToplam.toFixed(2))
            }

        })
    }
    
</script>

