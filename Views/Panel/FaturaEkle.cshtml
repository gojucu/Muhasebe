@*@model List<Muhasebe.Models.model_fatura_altUrun_liste>*@
@model Muhasebe.Models.Fatura


@{
    ViewBag.Title = "FaturaEkle";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}
<form id="faturaEkleKaydetForm" method="post">
    @Html.HiddenFor(model => model.Id, new { @value = "0" })
    <div class="p-box">
        <div class="row">
            <div class="col-md-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Fatura Ekle</h3>
                    </div>
                    <div class="box-body">

                        <div class="form-horizontal">
                            <h4>Fatura</h4>
                            <hr />
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                            <div class="form-group">
                                @Html.LabelFor(model => model.Aciklama, htmlAttributes: new { @class = "control-label col-md-2" })
                                <div class="col-md-10">
                                    @Html.EditorFor(model => model.Aciklama, new { htmlAttributes = new { @class = "form-control", @id = "Aciklama" } })
                                    @Html.ValidationMessageFor(model => model.Aciklama, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-2">
                                    <h5 style="float:right; font-weight:700">Kategoriler</h5>
                                </div>
                                <div class="col-md-10">
                                    @if (ViewBag.katttt == null)
                                    {
                                        <input type="text" name="kategoriler" id="kategoriler" value="" data-role="tagsinput" />
                                    }
                                    else
                                    {
                                        <input type="text" name="kategoriler" value="@ViewBag.katttt" id="kategoriler" data-role="tagsinput" />
                                    }

                                </div>
                            </div>

                            <div class="form-group">
                                <p class="control-label col-md-2">Müşteri</p>
                                <div class="col-md-10">
                                    @Html.DropDownListFor(model => model.MusteriID, new SelectList(ViewBag.musteri, "Id", "FirmaUnvani"), ""@*, new { htmlAttributes = new { @id = "MusteriID" } }*@)
                                    @Html.ValidationMessageFor(model => model.MusteriID, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            @if (Model == null)
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.Irsaliye, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.Irsaliye, new SelectList(ViewBag.irsaliye, "Ad", "Ad"), new { htmlAttributes = new { @id = "Irsaliye" } })
                                        @Html.ValidationMessageFor(model => model.Irsaliye, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.Irsaliye, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.Irsaliye, new SelectList(ViewBag.irsaliye, "Ad", "Ad"), Model.Irsaliye, new { htmlAttributes = new { @id = "Irsaliye" } })
                                        @Html.ValidationMessageFor(model => model.Irsaliye, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }

                            <div class="form-group">
                                @Html.LabelFor(model => model.DuzenlemeTarih, htmlAttributes: new { @class = "control-label col-md-2" })
                                <div class="col-md-10">
                                    @Html.EditorFor(model => model.DuzenlemeTarih, new { htmlAttributes = new { @class = "form-control datepicker", @id = "DuzenlemeTarih" } })
                                    @Html.ValidationMessageFor(model => model.DuzenlemeTarih, "", new { @class = "text-danger" })
                                </div>
                            </div>

                            <div class="form-group">
                                @Html.LabelFor(model => model.VadeTarihi, htmlAttributes: new { @class = "control-label col-md-2" })
                                <div class="col-md-10">
                                    @Html.EditorFor(model => model.VadeTarihi, new { htmlAttributes = new { @class = "form-control datepicker", @id = "VadeTarihi" } })
                                    @Html.ValidationMessageFor(model => model.VadeTarihi, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div>
                                <p class="control-label col-md-2">Fatura No:</p>
                                <div class="form-group col-md-5">
                                    <p class="control-label col-md-2">Seri</p>
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.FaturaNoSeri, new { htmlAttributes = new { @class = "", @id = "FaturaNoSeri" } })
                                        @Html.ValidationMessageFor(model => model.FaturaNoSeri, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="form-group col-md-5">
                                    <p class="control-label col-md-2">Sıra</p>
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.FaturaNoSira, new { htmlAttributes = new { @class = "", @id = "FaturaNoSira" } })
                                        @Html.ValidationMessageFor(model => model.FaturaNoSira, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            @if (Model == null)
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.FaturaDovizi, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.FaturaDovizi, new SelectList(ViewBag.faturaDoviz, "Ad", "Ad"), new { htmlAttributes = new { @class = "" } })
                                        @Html.ValidationMessageFor(model => model.FaturaDovizi, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="form-group">
                                    @Html.LabelFor(model => model.FaturaDovizi, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.DropDownListFor(model => model.FaturaDovizi, new SelectList(ViewBag.faturaDoviz, "Ad", "Ad"), Model.FaturaDovizi, new { htmlAttributes = new { @class = "" } })
                                        @Html.ValidationMessageFor(model => model.FaturaDovizi, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            }

                            <div class="form-group">
                                <div class="col-md-offset-2 col-md-10">
                                    <a class="btn col-md-12 btn-primary" onclick="return islemler.UrunKaydet()">
                                        <i class="fa fa-save"></i> Kaydet
                                    </a>
                                </div>
                            </div>
                        </div>
                        @*Tablo kısmı*@

                        @Html.DropDownList("urunAd", new SelectList(ViewBag.urun, "Id", "Ad"), new { @class = "hidden form-control" })

                        @Html.DropDownList("urunKdv", new SelectList(ViewBag.kdv, "Miktar", "Miktar"), new { @class = "hidden form-control" })
                        <hr />
                        <table id="urunler" class="table table-striped table-bordered align-items-baseline col-md-12">
                            <thead style="background-color:lightgray;">
                                <tr style="height:40px;">
                                    <th>
                                        Hizmet/Ürün
                                    </th>
                                    <th>
                                        Miktar
                                    </th>
                                    <th>
                                        BR. FİYAT
                                    </th>
                                    <th>
                                        VERGİ
                                    </th>
                                    <th>
                                        TOPLAM
                                    </th>
                                    <th>

                                    </th>
                                </tr>
                            </thead>
                            <tbody>

                                @if (ViewBag.list != null)
                                {
                                    foreach (var itemi in ViewBag.list)
                                    {

                                        <tr>
                                            <td>
                                                <input type="hidden" class="altId" value="@itemi.altId" />
                                                @Html.DropDownList("urunAd", new SelectList(ViewBag.urun, "Id", "Ad", itemi.HizmetUrunID), new { @class = " form-control select2 HizmetUrunID" })
                                            </td>
                                            <td>
                                                <input style="margin:15px; width:90%;" class="form-control Miktar" type="number" name="Miktar" value="@itemi.Miktar" onkeyup = "return toplamHesaplama(event)" />
                                            </td>
                                            <td>
                                                @foreach (var item in ViewBag.urun)
                                                {
                                                    if (item.Id == itemi.HizmetUrunID)
                                                    {
                                                        var urunFiyat = item.VergilerHaricSatis;
                                                    }
                                                }

                                                <input type="hidden" class="Fiyatt" value="urunFiyat" />
                                                <input style="margin:15px; width:90%;" class="form-control BirimFiyat" type="number" name="BirimFiyat" value="@itemi.BirimFiyat" />
                                            </td>
                                            <td>
                                                @Html.DropDownList("urunKdv", new SelectList(ViewBag.kdv, "Miktar", "Miktar", itemi.Vergi), new { @class = "form-control Vergi" })

                                            </td>
                                            <td>
                                                <input style="margin:15px; width:90%;" class="form-control toplam" type="text">
                                            </td>
                                            <td>
                                                @*<a class="btn col-md-12 btn-primary" onclick="return islemler.hizmetUrunSil(@itemi.altId)">
                                                        <i class="fa fa-remove"></i> X
                                                    </a>*@

                                                <button type="button" id="urunSil" class="btn col-md-2 btn-primary">x</button>
                                            </td>
                                        </tr>



                                    }

                                }
                            </tbody>
                        </table>


                        <button type="button" id="urunEkle" class="btn col-md-2 btn-primary">Satır Ekle</button>
                        @*<a class="add btn col-md-2 btn-primary">
                                Satır Ekle
                            </a>*@
                        <hr />
                        <div>
                            @Html.ActionLink("Listeye Dön", "Faturalar")
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>



    $(function () {
        $('.select2').select2();
        //get elements by class name ile ürünleri alıp select 2 eklettir.
        $(".datepicker").datepicker({
            autoclose: true,
        });
        urunlerTablo = $("#urunler").DataTable({
            "paging": false,
            "ordering": false,
            "info": false,
            "searching": false,
            "columnDefs": [
                { "width": "10%", "targets": 0 }
            ]
        });


        $(document).ready(function () {

            $('#urunEkle').on('click', add);
            //$('#urunSil').on('click', remove);
            var dat = $("#urunKdv").html();
            var dat2 = $("#urunAd").html();

            //$(".HizmetUrunID").append(dat2);
            //$(".Vergi").append(dat);

            $('#urunler tbody').on('click', '#urunSil', function () {
                urunlerTablo
                    .row($(this).parents('tr'))
                    .remove()
                    .draw();
            });

            function add() {

                urunlerTablo.row.add([
                    '<select style="margin:15px; width:90%;" class="form-control select2 HizmetUrunID" name="HizmetUrunID" >' + dat2 + '<select/>', '<input style="margin:15px;width:90%;"class="formcontrol Miktar" type="number" name="Miktar"  value="" />', '<input style="margin:15px; width:90%;" class="form-control BirimFiyat"type="number"name="BirimFiyat" value="" />', '<select  class="form-control Vergi" name="Vergi" >' + dat + '<select/>', '<input style="margin:15px; width:90%;" class="formcontrol"type="text">', '<button type = "button" id = "urunSil" class= "btn col-md-2 btn-primary" > x</button >']).draw(false);

                $('.select2').select2();

            }

            $("tr").each(function (index, value) {

                if (index != 0) {

                    $(this).find(".Miktar").on("input", function () {
                        var miktar = $(this).find(".Miktar").val();
                        var birimFiyat = $(this).find(".BirimFiyat").val();
                        var vergi = $(this).find(".Vergi").val();

                        var toplam = miktar * (birimFiyat * (1 + (vergi / 100)));

                        $(this).find(".toplam").val(toplam);
                    });
                }
            })

        })
    })
    function toplamHesaplama() {
        $("tr").each(function (index, value) {
            if (index != 0) {

                var miktar = $(this).find(".Miktar").val();
                var birimFiyat = $(this).find(".BirimFiyat").val();
                var vergi = $(this).find(".Vergi").val();

                var toplam = miktar * (birimFiyat * (1 + (vergi / 100)));

                $(this).find(".toplam").val(toplam);
                toplamHesaplama(toplam);
            }

        })
    }

    //function toplamHesaplama() {

    //    var alis = parseFloat($('.Miktar').val());
    //    var satis = parseFloat($('.BirimFiyat').val());

    //    var kdv = parseFloat($('.Vergi option:selected').val());
    //    //var oiv = parseFloat($('#Oiv').val());
    //    //if (isNaN(oiv)) {
    //    //    oiv = 0;
    //    //}
    //    //var alisOtv = parseFloat($('#AlisOtv').val());
    //    //if (isNaN(alisOtv)) {
    //    //    alisOtv = 0;
    //    //}
    //    //var alisTur = $('#AlisOtvTur option:selected').val();

    //    //var satisOtv = parseFloat($('#SatisOtv').val());
    //    //if (isNaN(satisOtv)) {
    //    //    satisOtv = 0;
    //    //}
    //    //var satisOtvTur = $('#SatisOtvTur option:selected').val();

    //    //if (alisTur == "%         ") { //alisTur ve satisOtvTur de seçimlerden sonra boşluk var soldaki şekilde yapınca sıkıntı çıkmıyor ama yinede hoş değil

    //    //    var alisotvHesap = (alis * alisOtv) / 100 + alis;
    //    //    var dahilAlisSonuc = parseFloat((alisotvHesap * (kdv + oiv)) / 100 + alisotvHesap).toFixed(2);

    //    //} else if (alisTur == "₺         ") {
    //    //    var alisotvHesap = alis + alisOtv;
    //    //    var dahilAlisSonuc = parseFloat((alisotvHesap * (kdv + oiv)) / 100 + alisotvHesap).toFixed(2);
    //    //}

    //    if (satisOtvTur == "%         ") {
    //        var satisotvHesap = (satis * satisOtv) / 100 + satis;
    //        var dahilSatisSonuc = parseFloat((satisotvHesap * (kdv + oiv)) / 100 + satisotvHesap).toFixed(2);
    //    } else if (satisOtvTur == "₺         ") {
    //        var satisotvHesap = satis + satisOtv;
    //        var dahilSatisSonuc = parseFloat((satisotvHesap * (kdv + oiv)) / 100 + satisotvHesap).toFixed(2);
    //    }
    //    $('#vergidahilalis').val(dahilAlisSonuc);
    //    $('#vergidahilsatis').val(dahilSatisSonuc);

    //}


</script>

